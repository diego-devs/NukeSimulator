<!DOCTYPE html>
<html>
<head>
    <title>Nuclear Annihilation Simulator</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #map { height: 100%; flex-grow: 1; background-color: #aad3df; }
        .panel { width: 320px; padding: 15px; box-sizing: border-box; background-color: #f0f0f0; overflow-y: auto; border-left: 1px solid #ccc; border-right: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #config-panel { order: -1; border-right: 1px solid #ccc; border-left: none; }
        #info-panel { border-left: 1px solid #ccc; border-right: none; }
        h3, h4 { margin-top: 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        h4 { margin-top: 15px; margin-bottom: 5px; color: #444; border-bottom: 1px dashed #ddd; padding-bottom: 3px; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .control-group input[type="range"], .control-group input[type="number"] { width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .control-group input[type="number"] { width: calc(100% - 12px); }
        #info-panel p, #info-panel li { margin: 6px 0; line-height: 1.3; font-size: 0.9em; }
        #info-panel strong { color: #444; }
        #bomb-power-value { display: inline-block; margin-left: 10px; font-weight: normal; color: #333; }
        #bomb-history-list { list-style-type: none; padding-left: 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; background-color: #fff; padding: 5px; margin-top: 5px; }
        #bomb-history-list li { padding: 4px; border-bottom: 1px solid #eee; font-size: 0.85em; }
        #bomb-history-list li:last-child { border-bottom: none; }
        .total-stats { margin-top: auto; padding-top: 10px; border-top: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="config-panel" class="panel">
        <h3>Configuration</h3>
        <div class="control-group">
            <label for="bomb-power">Bomb Power: <span id="bomb-power-value">20 KT</span></label>
            <input type="range" id="bomb-power" name="bomb-power" min="1" max="50000" value="20" step="1">
        </div>
        <div class="control-group">
            <label for="num-waves">Number of Shockwaves:</label>
            <input type="number" id="num-waves" name="num-waves" min="1" max="5" value="3">
        </div>
        <div class="control-group">
            <label for="wave-duration">Wave Duration (ms):</label>
            <input type="number" id="wave-duration" name="wave-duration" min="1000" max="7000" value="3000" step="100">
        </div>
    </div>

    <div id="map"></div>

    <div id="info-panel" class="panel">
        <div>
            <h3>Current Impact</h3>
            <p><strong>Target Coordinates:</strong><br><span id="target-coords">-</span></p>
            <p><strong>Est. Fatalities (this bomb):</strong><br><span id="est-deaths-current">-</span></p>
            <p><strong>Est. Injured (this bomb):</strong><br><span id="est-injured-current">-</span></p>
            <p><strong>Severe Damage Radius (approx. 5psi):</strong><br><span id="est-destruction">-</span></p>
            <p><strong>Additional Info:</strong><br><span id="add-info">-</span></p>

            <h4>Bomb Log (<span id="bomb-count">0</span>)</h4>
            <ul id="bomb-history-list"><li>No bombs dropped yet.</li></ul>
        </div>
        <div class="total-stats">
            <h4>Global Status</h4>
            <p><strong>Total Initial Population:</strong> <span id="initial-world-pop">0</span></p>
            <p><strong>Total Fatalities (Cumulative):</strong> <span id="total-fatalities-world">0</span></p>
            <p><strong>Total Injured (Cumulative):</strong> <span id="total-injured-world">0</span></p>
            <p><strong>Total Remaining Population:</strong> <span id="total-remaining-pop-world">0</span></p>
        </div>
    </div>

    <script>
        const map = L.map('map').setView([20, 0], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors', maxZoom: 18,
        }).addTo(map);

        // UI Elements
        const bombPowerInput = document.getElementById('bomb-power');
        const bombPowerValueDisplay = document.getElementById('bomb-power-value');
        const numWavesInput = document.getElementById('num-waves');
        const waveDurationInput = document.getElementById('wave-duration');
        const targetCoordsDisplay = document.getElementById('target-coords');
        const estDeathsCurrentDisplay = document.getElementById('est-deaths-current');
        const estInjuredCurrentDisplay = document.getElementById('est-injured-current');
        const estDestructionDisplay = document.getElementById('est-destruction');
        const addInfoDisplay = document.getElementById('add-info');
        const bombCountDisplay = document.getElementById('bomb-count');
        const bombHistoryList = document.getElementById('bomb-history-list');
        const initialWorldPopDisplay = document.getElementById('initial-world-pop');
        const totalFatalitiesWorldDisplay = document.getElementById('total-fatalities-world');
        const totalInjuredWorldDisplay = document.getElementById('total-injured-world');
        const totalRemainingPopWorldDisplay = document.getElementById('total-remaining-pop-world');

        // Data for major cities: { name, lat, lng, population (metro area approx) }
        const majorCities = [
    // Existing + More
    { name: "Tokyo", lat: 35.6895, lng: 139.6917, population: 37400000 },
    { name: "Delhi", lat: 28.7041, lng: 77.1025, population: 30290000 },
    { name: "Shanghai", lat: 31.2304, lng: 121.4737, population: 27058000 },
    { name: "Sao Paulo", lat: -23.5505, lng: -46.6333, population: 22000000 },
    { name: "Mexico City", lat: 19.4326, lng: -99.1332, population: 21800000 },
    { name: "Cairo", lat: 30.0444, lng: 31.2357, population: 21000000 },
    { name: "Beijing", lat: 39.9042, lng: 116.4074, population: 20500000 },
    { name: "Mumbai", lat: 19.0760, lng: 72.8777, population: 20400000 },
    { name: "Osaka", lat: 34.6937, lng: 135.5023, population: 19200000 },
    { name: "New York City", lat: 40.7128, lng: -74.0060, population: 20100000 },
    { name: "Karachi", lat: 24.8607, lng: 67.0011, population: 16000000 },
    { name: "Buenos Aires", lat: -34.6037, lng: -58.3816, population: 15100000 },
    { name: "Istanbul", lat: 41.0082, lng: 28.9784, population: 15500000 },
    { name: "Kolkata", lat: 22.5726, lng: 88.3639, population: 14800000 },
    { name: "Manila", lat: 14.5995, lng: 120.9842, population: 13900000 },
    { name: "Lagos", lat: 6.5244, lng: 3.3792, population: 14800000 },
    { name: "Rio de Janeiro", lat: -22.9068, lng: -43.1729, population: 13500000 },
    { name: "Los Angeles", lat: 34.0522, lng: -118.2437, population: 18700000 },
    { name: "Moscow", lat: 55.7558, lng: 37.6173, population: 12600000 },
    { name: "London", lat: 51.5074, lng: -0.1278, population: 14200000 },
    { name: "Paris", lat: 48.8566, lng: 2.3522, population: 11000000 },
    { name: "Jakarta", lat: -6.2088, lng: 106.8456, population: 30000000 }, // Greater Jakarta
    { name: "Lima", lat: -12.0464, lng: -77.0428, population: 10000000 },
    { name: "Seoul", lat: 37.5665, lng: 126.9780, population: 25600000 }, // Seoul Capital Area
    { name: "Bangkok", lat: 13.7563, lng: 100.5018, population: 10500000 },
    { name: "Chicago", lat: 41.8781, lng: -87.6298, population: 9500000 },
    { name: "Tehran", lat: 35.6892, lng: 51.3890, population: 15000000 }, // Metro
    { name: "Kinshasa", lat: -4.4419, lng: 15.2663, population: 14000000 },
    { name: "Bogota", lat: 4.7110, lng: -74.0721, population: 11000000 },
    { name: "Sydney", lat: -33.8688, lng: 151.2093, population: 5300000 },
    { name: "Berlin", lat: 52.5200, lng: 13.4050, population: 6000000 },   // Metro
    { name: "Madrid", lat: 40.4168, lng: -3.7038, population: 6700000 },    // Metro
    { name: "Rome", lat: 41.9028, lng: 12.4964, population: 4300000 },     // Metro
    { name: "Toronto", lat: 43.6532, lng: -79.3832, population: 6200000 }, // Metro
    { name: "Santiago", lat: -33.4489, lng: -70.6693, population: 6100000 },
    { name: "Riyadh", lat: 24.7136, lng: 46.6753, population: 7700000 },
    { name: "Singapore", lat: 1.3521, lng: 103.8198, population: 5700000 },
    { name: "Hong Kong", lat: 22.3193, lng: 114.1694, population: 7500000 },
    { name: "Baghdad", lat: 33.3152, lng: 44.3661, population: 7200000 },
    { name: "Nairobi", lat: -1.2921, lng: 36.8219, population: 4400000 },
    { name: "Johannesburg", lat: -26.2041, lng: 28.0473, population: 5600000 },
    { name: "Ho Chi Minh City", lat: 10.762622, lng: 106.660172, population: 9000000 },
    { name: "Kuala Lumpur", lat: 3.1390, lng: 101.6869, population: 8200000 }, // Metro
    { name: "Alexandria", lat: 31.2001, lng: 29.9187, population: 5200000 },
    { name: "Guangzhou", lat: 23.1291, lng: 113.2644, population: 15300000 },
    { name: "Shenzhen", lat: 22.5431, lng: 114.0579, population: 12600000 },
    { name: "Wuhan", lat: 30.5928, lng: 114.3055, population: 11000000 },
    { name: "Chengdu", lat: 30.5728, lng: 104.0668, population: 16300000 },
    { name: "Chongqing", lat: 29.4316, lng: 106.9123, population: 32000000 }, // Municipality
    { name: "Dhaka", lat: 23.8103, lng: 90.4125, population: 21000000 },
    { name: "Lahore", lat: 31.5204, lng: 74.3587, population: 12600000 },
    { name: "Bangalore", lat: 12.9716, lng: 77.5946, population: 12300000 },
    { name: "Chennai", lat: 13.0827, lng: 80.2707, population: 11000000 },
    { name: "Hyderabad (India)", lat: 17.3850, lng: 78.4867, population: 10000000 },
    { name: "Ahmedabad", lat: 23.0225, lng: 72.5714, population: 8000000 },
    { name: "Pune", lat: 18.5204, lng: 73.8567, population: 7400000 },
    { name: "Surat", lat: 21.1702, lng: 72.8311, population: 6900000 },
    { name: "Ankara", lat: 39.9334, lng: 32.8597, population: 5400000 },
    { name: "Izmir", lat: 38.4237, lng: 27.1428, population: 4300000 },
    { name: "Kyiv", lat: 50.4501, lng: 30.5234, population: 2900000 },
    { name: "Saint Petersburg", lat: 59.9343, lng: 30.3351, population: 5400000 },
    { name: "Casablanca", lat: 33.5731, lng: -7.5898, population: 3700000 },
    { name: "Algiers", lat: 36.7783, lng: 3.0588, population: 3900000 },
    { name: "Accra", lat: 5.6037, lng: -0.1870, population: 4200000 }, // Greater Accra
    { name: "Khartoum", lat: 15.5007, lng: 32.5599, population: 5300000 },
    { name: "Dar es Salaam", lat: -6.7924, lng: 39.2083, population: 6400000 },
    { name: "Luanda", lat: -8.8390, lng: 13.2894, population: 8300000 },
    { name: "Abidjan", lat: 5.359952, lng: -4.008256, population: 5000000 },
    { name: "Addis Ababa", lat: 9.005401, lng: 38.763611, population: 5000000 },
    { name: "Kabul", lat: 34.5553, lng: 69.2075, population: 4300000 },
    { name: "Caracas", lat: 10.4806, lng: -66.9036, population: 2900000 }, // City Proper, Metro larger
    { name: "Medellin", lat: 6.2442, lng: -75.5812, population: 4000000 }, // Metro
    { name: "Guayaquil", lat: -2.1700, lng: -79.9224, population: 3000000 }, // Metro
    { name: "Brasilia", lat: -15.7942, lng: -47.8825, population: 4600000 }, // Metro
    { name: "Salvador (Brazil)", lat: -12.9747, lng: -38.4767, population: 3900000 }, // Metro
    { name: "Fortaleza", lat: -3.7319, lng: -38.5267, population: 4100000 }, // Metro
    { name: "Recife", lat: -8.0476, lng: -34.8770, population: 4100000 }, // Metro
    { name: "Curitiba", lat: -25.4284, lng: -49.2733, population: 3700000 }, // Metro
    { name: "Havana", lat: 23.1136, lng: -82.3666, population: 2100000 },
    { name: "Quito", lat: -0.1807, lng: -78.4678, population: 2800000 }, // Metro
    { name: "Montevideo", lat: -34.9011, lng: -56.1645, population: 1700000 }, // Metro
    { name: "Vancouver", lat: 49.2827, lng: -123.1207, population: 2600000 }, // Metro
    { name: "Montreal", lat: 45.5017, lng: -73.5673, population: 4200000 }, // Metro
    { name: "Houston", lat: 29.7604, lng: -95.3698, population: 7100000 }, // Metro
    { name: "Dallas", lat: 32.7767, lng: -96.7970, population: 7600000 }, // Metro
    { name: "Philadelphia", lat: 39.9526, lng: -75.1652, population: 6100000 }, // Metro
    { name: "Miami", lat: 25.7617, lng: -80.1918, population: 6100000 }, // Metro
    { name: "Atlanta", lat: 33.7490, lng: -84.3880, population: 6000000 }, // Metro
    { name: "Washington D.C.", lat: 38.9072, lng: -77.0369, population: 6300000 }, // Metro
    { name: "Boston", lat: 42.3601, lng: -71.0589, population: 4900000 }, // Metro
    { name: "San Francisco", lat: 37.7749, lng: -122.4194, population: 4700000 }, // Metro (Bay Area is larger)
    { name: "Seattle", lat: 47.6062, lng: -122.3321, population: 4000000 }, // Metro
    { name: "Phoenix", lat: 33.4484, lng: -112.0740, population: 4800000 }, // Metro
    { name: "Detroit", lat: 42.3314, lng: -83.0458, population: 4300000 }, // Metro
    { name: "San Diego", lat: 32.7157, lng: -117.1611, population: 3300000 }, // Metro
    { name: "Minneapolis", lat: 44.9778, lng: -93.2650, population: 3600000 }, // Metro
    { name: "Melbourne", lat: -37.8136, lng: 144.9631, population: 5100000 },
    { name: "Perth", lat: -31.9505, lng: 115.8605, population: 2100000 },
    { name: "Auckland", lat: -36.8485, lng: 174.7633, population: 1700000 },
    { name: "Warsaw", lat: 52.2297, lng: 21.0122, population: 3100000 }, // Metro
    { name: "Budapest", lat: 47.4979, lng: 19.0402, population: 3000000 }, // Metro
    { name: "Vienna", lat: 48.2082, lng: 16.3738, population: 2600000 }, // Metro
    { name: "Prague", lat: 50.0755, lng: 14.4378, population: 2700000 }, // Metro
    { name: "Bucharest", lat: 44.4268, lng: 26.1025, population: 2200000 }, // Metro
    { name: "Athens", lat: 37.9838, lng: 23.7275, population: 3100000 }, // Metro
    { name: "Amsterdam", lat: 52.3676, lng: 4.9041, population: 2500000 }, // Metro
    { name: "Brussels", lat: 50.8503, lng: 4.3517, population: 2500000 }, // Metro
    { name: "Dublin", lat: 53.3498, lng: -6.2603, population: 1400000 }, // Metro
    { name: "Stockholm", lat: 59.3293, lng: 18.0686, population: 2400000 }, // Metro
    { name: "Oslo", lat: 59.9139, lng: 10.7522, population: 1500000 }, // Metro
    { name: "Copenhagen", lat: 55.6761, lng: 12.5683, population: 2000000 }, // Metro
    { name: "Helsinki", lat: 60.1699, lng: 24.9384, population: 1300000 }, // Metro
    { name: "Lisbon", lat: 38.7223, lng: -9.1393, population: 2800000 }, // Metro
    { name: "Zurich", lat: 47.3769, lng: 8.5417, population: 1400000 }, // Metro
    { name: "Geneva", lat: 46.2044, lng: 6.1432, population: 1000000 }, // Metro
    { name: "Nagoya", lat: 35.1815, lng: 136.9066, population: 9500000 }, // Japan, Metro
    { name: "Fukuoka", lat: 33.5904, lng: 130.4017, population: 5100000 }, // Japan, Metro
    { name: "Sapporo", lat: 43.0618, lng: 141.3545, population: 2600000 }, // Japan, Metro
    { name: "Busan", lat: 35.1796, lng: 129.0756, population: 3400000 }, // South Korea
    { name: "Incheon", lat: 37.4563, lng: 126.7052, population: 3000000 }, // South Korea
    { name: "Daegu", lat: 35.8714, lng: 128.6014, population: 2400000 }, // South Korea
    { name: "Pyongyang", lat: 39.0392, lng: 125.7625, population: 3200000 }, // North Korea
    { name: "Taipei", lat: 25.0330, lng: 121.5654, population: 7000000 }, // Taiwan, Metro
    { name: "Kaohsiung", lat: 22.6273, lng: 120.3014, population: 2800000 }, // Taiwan
    { name: "Taichung", lat: 24.1477, lng: 120.6736, population: 2800000 }, // Taiwan
    { name: "Hanoi", lat: 21.0278, lng: 105.8342, population: 8000000 }, // Vietnam, Metro
    { name: "Yangon", lat: 16.8661, lng: 96.1951, population: 7300000 }, // Myanmar
    { name: "Medan", lat: 3.5952, lng: 98.6722, population: 4700000 }, // Indonesia, Metro
    { name: "Surabaya", lat: -7.2575, lng: 112.7521, population: 10000000 }, // Indonesia, Metro
    { name: "Bandung", lat: -6.9175, lng: 107.6191, population: 8600000 }, // Indonesia, Metro
    { name: "Cebu City", lat: 10.3157, lng: 123.8854, population: 3000000 }, // Philippines, Metro
    { name: "Davao City", lat: 7.1907, lng: 125.4553, population: 1800000 }, // Philippines
    { name: "Chittagong", lat: 22.3569, lng: 91.7832, population: 5000000 }, // Bangladesh
    { name: "Faisalabad", lat: 31.4180, lng: 73.0790, population: 3200000 }, // Pakistan
    { name: "Rawalpindi", lat: 33.5651, lng: 73.0169, population: 3500000 }, // Pakistan (often twinned w/ Islamabad)
    { name: "Jaipur", lat: 26.9124, lng: 75.7873, population: 3100000 }, // India
    { name: "Lucknow", lat: 26.8467, lng: 80.9462, population: 3000000 }, // India
    { name: "Kanpur", lat: 26.4499, lng: 80.3319, population: 2900000 }, // India
    { name: "Nagpur", lat: 21.1458, lng: 79.0882, population: 2500000 }, // India
    { name: "Indore", lat: 22.7196, lng: 75.8577, population: 2000000 }, // India
    { name: "Bhopal", lat: 23.2599, lng: 77.4126, population: 1800000 }, // India
    { name: "Ludhiana", lat: 30.9010, lng: 75.8573, population: 1600000 }, // India
    { name: "Agra", lat: 27.1767, lng: 78.0081, population: 1600000 }, // India
    { name: "Nashik", lat: 19.9975, lng: 73.7898, population: 1500000 }, // India
    { name: "Vadodara", lat: 22.3072, lng: 73.1812, population: 1800000 }, // India
    { name: "Ghaziabad", lat: 28.6692, lng: 77.4538, population: 2300000 }, // India (part of Delhi NCR)
    { name: "Mashhad", lat: 36.2970, lng: 59.6062, population: 3000000 }, // Iran
    { name: "Isfahan", lat: 32.6546, lng: 51.6680, population: 2000000 }, // Iran
    { name: "Shiraz", lat: 29.5918, lng: 52.5837, population: 1900000 }, // Iran
    { name: "Tabriz", lat: 38.0799, lng: 46.2901, population: 1600000 }, // Iran
    { name: "Jeddah", lat: 21.4858, lng: 39.1925, population: 4700000 }, // Saudi Arabia
    { name: "Mecca", lat: 21.3891, lng: 39.8579, population: 2000000 }, // Saudi Arabia
    { name: "Medina", lat: 24.5247, lng: 39.5692, population: 1500000 }, // Saudi Arabia
    { name: "Damascus", lat: 33.5138, lng: 36.2765, population: 2100000 }, // Syria (pre-war estimates vary)
    { name: "Aleppo", lat: 36.2021, lng: 37.1343, population: 1800000 }, // Syria (pre-war estimates vary)
    { name: "Amman", lat: 31.9454, lng: 35.9284, population: 4000000 }, // Jordan
    { name: "Beirut", lat: 33.8938, lng: 35.5018, population: 2400000 }, // Lebanon, Metro
    { name: "Tel Aviv", lat: 32.0853, lng: 34.7818, population: 4300000 }, // Israel, Gush Dan Metro
    { name: "Jerusalem", lat: 31.7683, lng: 35.2137, population: 930000 }, // Israel (pop figures can be complex)
    { name: "Gaza City", lat: 31.5000, lng: 34.4667, population: 2000000 }, // Gaza Strip (includes wider urban area)
    { name: "Kuwait City", lat: 29.3759, lng: 47.9774, population: 3000000 }, // Kuwait, Metro
    { name: "Doha", lat: 25.2854, lng: 51.5310, population: 2400000 }, // Qatar
    { name: "Dubai", lat: 25.2048, lng: 55.2708, population: 3300000 }, // UAE
    { name: "Abu Dhabi", lat: 24.4539, lng: 54.3773, population: 1500000 }, // UAE
    { name: "Muscat", lat: 23.5880, lng: 58.3829, population: 1500000 }, // Oman
    { name: "Sana'a", lat: 15.3694, lng: 44.1910, population: 3000000 }, // Yemen
    { name: "Novosibirsk", lat: 55.0084, lng: 82.9357, population: 1600000 }, // Russia
    { name: "Yekaterinburg", lat: 56.8380, lng: 60.5970, population: 1500000 }, // Russia
    { name: "Nizhny Novgorod", lat: 56.3269, lng: 44.0059, population: 1200000 }, // Russia
    { name: "Kazan", lat: 55.7963, lng: 49.1088, population: 1200000 }, // Russia
    { name: "Chelyabinsk", lat: 55.1644, lng: 61.4368, population: 1200000 }, // Russia
    { name: "Omsk", lat: 54.9886, lng: 73.3242, population: 1100000 }, // Russia
    { name: "Samara", lat: 53.1959, lng: 50.1002, population: 1100000 }, // Russia
    { name: "Rostov-on-Don", lat: 47.2221, lng: 39.7188, population: 1100000 }, // Russia
    { name: "Ufa", lat: 54.7351, lng: 55.9586, population: 1100000 }, // Russia
    { name: "Volgograd", lat: 48.7080, lng: 44.5133, population: 1000000 }, // Russia
    { name: "Perm", lat: 58.0105, lng: 56.2502, population: 1000000 }, // Russia
    { name: "Krasnoyarsk", lat: 56.0106, lng: 92.8525, population: 1000000 }, // Russia
    { name: "Minsk", lat: 53.9045, lng: 27.5615, population: 2000000 }, // Belarus
    { name: "Kharkiv", lat: 49.9935, lng: 36.2304, population: 1400000 }, // Ukraine
    { name: "Odesa", lat: 46.4825, lng: 30.7233, population: 1000000 }, // Ukraine
    { name: "Dnipro", lat: 48.4647, lng: 35.0462, population: 1000000 }, // Ukraine
    { name: "Donetsk", lat: 48.0159, lng: 37.8028, population: 900000 }, // Ukraine (pre-conflict)
    { name: "Baku", lat: 40.4093, lng: 49.8671, population: 2300000 }, // Azerbaijan
    { name: "Tbilisi", lat: 41.7151, lng: 44.7867, population: 1100000 }, // Georgia
    { name: "Yerevan", lat: 40.1792, lng: 44.4991, population: 1100000 }, // Armenia
    { name: "Tashkent", lat: 41.2995, lng: 69.2401, population: 2500000 }, // Uzbekistan
    { name: "Almaty", lat: 43.2220, lng: 76.8512, population: 2000000 }, // Kazakhstan
    { name: "Nur-Sultan (Astana)", lat: 51.1694, lng: 71.4491, population: 1200000 }, // Kazakhstan
    { name: "Bishkek", lat: 42.8746, lng: 74.5698, population: 1000000 }, // Kyrgyzstan
    { name: "Dushanbe", lat: 38.5598, lng: 68.7870, population: 860000 }, // Tajikistan
    { name: "Ashgabat", lat: 37.9601, lng: 58.3261, population: 1000000 }, // Turkmenistan
    { name: "Ulaanbaatar", lat: 47.8864, lng: 106.9057, population: 1500000 }, // Mongolia
    { name: "Adelaide", lat: -34.9285, lng: 138.6007, population: 1300000 }, // Australia
    { name: "Brisbane", lat: -27.4698, lng: 153.0251, population: 2500000 }, // Australia
    { name: "Canberra", lat: -35.2809, lng: 149.1300, population: 430000 }, // Australia
    { name: "Wellington", lat: -41.2865, lng: 174.7762, population: 420000 }, // New Zealand
    { name: "Christchurch", lat: -43.5321, lng: 172.6362, population: 400000 }, // New Zealand
    { name: "Port Moresby", lat: -9.4438, lng: 147.1803, population: 400000 }, // Papua New Guinea
    { name: "Suva", lat: -18.1416, lng: 178.4501, population: 100000 }, // Fiji (Urban area larger)
    { name: "Honolulu", lat: 21.3069, lng: -157.8583, population: 1000000 }, // USA, Hawaii (Metro)
    { name: "Anchorage", lat: 61.2181, lng: -149.9003, population: 300000 }, // USA, Alaska
    { name: "Montgomery", lat: 32.3668, lng: -86.3000, population: 370000, isCapital: true }, // Alabama (Metro)
    { name: "Juneau", lat: 58.3019, lng: -134.4197, population: 32000, isCapital: true },    // Alaska
    // Phoenix is Arizona's capital, likely already listed.
    { name: "Little Rock", lat: 34.7465, lng: -92.2896, population: 740000, isCapital: true }, // Arkansas (Metro)
    { name: "Sacramento", lat: 38.5816, lng: -121.4944, population: 2400000, isCapital: true },// California (Metro)
    { name: "Denver", lat: 39.7392, lng: -104.9903, population: 2900000, isCapital: true },  // Colorado (Metro) - Likely already listed
    { name: "Hartford", lat: 41.7658, lng: -72.6734, population: 1200000, isCapital: true },  // Connecticut (Metro)
    { name: "Dover", lat: 39.1582, lng: -75.5244, population: 180000, isCapital: true },     // Delaware (Metro)
    { name: "Tallahassee", lat: 30.4383, lng: -84.2807, population: 390000, isCapital: true },// Florida (Metro)
    // Atlanta is Georgia's capital, likely already listed.
    // Honolulu is Hawaii's capital, likely already listed.
    { name: "Boise", lat: 43.6150, lng: -116.2023, population: 750000, isCapital: true },    // Idaho (Metro)
    { name: "Springfield (IL)", lat: 39.7817, lng: -89.6501, population: 210000, isCapital: true },// Illinois (Metro)
    { name: "Indianapolis", lat: 39.7684, lng: -86.1581, population: 2100000, isCapital: true },// Indiana (Metro) - Likely already listed
    { name: "Des Moines", lat: 41.5908, lng: -93.6208, population: 700000, isCapital: true }, // Iowa (Metro)
    { name: "Topeka", lat: 39.0473, lng: -95.6770, population: 230000, isCapital: true },    // Kansas (Metro)
    { name: "Frankfort", lat: 38.2009, lng: -84.8733, population: 75000, isCapital: true },   // Kentucky
    { name: "Baton Rouge", lat: 30.4515, lng: -91.1871, population: 850000, isCapital: true },// Louisiana (Metro)
    { name: "Augusta (ME)", lat: 44.3106, lng: -69.7795, population: 120000, isCapital: true },// Maine (Metro area around)
    { name: "Annapolis", lat: 38.9784, lng: -76.4922, population: 40000, isCapital: true },  // Maryland (part of Baltimore-Washington metro)
    // Boston is Massachusetts' capital, likely already listed.
    { name: "Lansing", lat: 42.7325, lng: -84.5555, population: 470000, isCapital: true },   // Michigan (Metro)
    { name: "Saint Paul", lat: 44.9537, lng: -93.0900, population: 3600000, isCapital: true },// Minnesota (Part of Minneapolis-St. Paul metro)
    { name: "Jackson (MS)", lat: 32.2988, lng: -90.1848, population: 590000, isCapital: true },// Mississippi (Metro)
    { name: "Jefferson City", lat: 38.5767, lng: -92.1735, population: 150000, isCapital: true },// Missouri (Metro)
    { name: "Helena", lat: 46.5927, lng: -112.0361, population: 80000, isCapital: true },    // Montana (Metro area around)
    { name: "Lincoln", lat: 40.8136, lng: -96.7026, population: 340000, isCapital: true },   // Nebraska (Metro)
    { name: "Carson City", lat: 39.1638, lng: -119.7674, population: 55000, isCapital: true },// Nevada
    { name: "Concord (NH)", lat: 43.2081, lng: -71.5376, population: 150000, isCapital: true },// New Hampshire (Metro area around)
    { name: "Trenton", lat: 40.2171, lng: -74.7429, population: 370000, isCapital: true },  // New Jersey (Metro)
    { name: "Santa Fe", lat: 35.6870, lng: -105.9378, population: 150000, isCapital: true }, // New Mexico (Metro)
    { name: "Albany (NY)", lat: 42.6526, lng: -73.7562, population: 1100000, isCapital: true },// New York (Metro - Capital District)
    { name: "Raleigh", lat: 35.7796, lng: -78.6382, population: 1400000, isCapital: true },  // North Carolina (Metro) - Likely already listed
    { name: "Bismarck", lat: 46.8083, lng: -100.7837, population: 130000, isCapital: true }, // North Dakota (Metro)
    { name: "Columbus (OH)", lat: 39.9612, lng: -82.9988, population: 2100000, isCapital: true },// Ohio (Metro) - Likely already listed
    { name: "Oklahoma City", lat: 35.4676, lng: -97.5164, population: 1400000, isCapital: true },// Oklahoma (Metro) - Likely already listed
    { name: "Salem (OR)", lat: 44.9429, lng: -123.0351, population: 430000, isCapital: true },// Oregon (Metro)
    { name: "Harrisburg", lat: 40.2732, lng: -76.8867, population: 570000, isCapital: true },// Pennsylvania (Metro)
    { name: "Providence", lat: 41.8240, lng: -71.4128, population: 1600000, isCapital: true },// Rhode Island (Metro)
    { name: "Columbia (SC)", lat: 34.0007, lng: -81.0348, population: 830000, isCapital: true },// South Carolina (Metro)
    { name: "Pierre", lat: 44.3683, lng: -100.3509, population: 20000, isCapital: true },    // South Dakota
    { name: "Nashville", lat: 36.1627, lng: -86.7816, population: 2000000, isCapital: true },// Tennessee (Metro) - Likely already listed
    { name: "Austin", lat: 30.2672, lng: -97.7431, population: 2200000, isCapital: true },   // Texas (Metro) - Likely already listed
    { name: "Salt Lake City", lat: 40.7608, lng: -111.8910, population: 1200000, isCapital: true },// Utah (Metro) - Likely already listed
    { name: "Montpelier", lat: 44.2601, lng: -72.5754, population: 30000, isCapital: true }, // Vermont (Metro area around)
    { name: "Richmond (VA)", lat: 37.5407, lng: -77.4360, population: 1300000, isCapital: true },// Virginia (Metro)
    { name: "Olympia", lat: 47.0379, lng: -122.9007, population: 290000, isCapital: true },  // Washington (Metro)
    { name: "Charleston (WV)", lat: 38.3498, lng: -81.6326, population: 260000, isCapital: true },// West Virginia (Metro)
    { name: "Madison", lat: 43.0731, lng: -89.4012, population: 660000, isCapital: true },   // Wisconsin (Metro)
    { name: "Cheyenne", lat: 41.1400, lng: -104.8202, population: 100000, isCapital: true }, // Wyoming (Metro)

// Other Major US Cities (some may be repeats if they are also capitals or already in your primary list)
// Check your existing list for these first; add/update as needed, especially metro populations.
    { name: "Birmingham (AL)", lat: 33.5207, lng: -86.8025, population: 1100000 }, // Alabama (Metro)
    { name: "Mobile", lat: 30.6954, lng: -88.0399, population: 430000 }, // Alabama (Metro)
    { name: "Huntsville", lat: 34.7304, lng: -86.5861, population: 490000 }, // Alabama (Metro)
    // Anchorage, AK already listed as capital.
    { name: "Tucson", lat: 32.2226, lng: -110.9747, population: 1000000 }, // Arizona (Metro)
    { name: "Mesa", lat: 33.4152, lng: -111.8315, population: 5000000 }, // Arizona (Part of Phoenix Metro)
    { name: "Chandler", lat: 33.3062, lng: -111.8413, population: 5000000 },// Arizona (Part of Phoenix Metro)
    { name: "Scottsdale", lat: 33.4942, lng: -111.9261, population: 5000000 },// Arizona (Part of Phoenix Metro)
    { name: "Glendale (AZ)", lat: 33.5387, lng: -112.1860, population: 5000000 },// Arizona (Part of Phoenix Metro)
    // Los Angeles, San Diego, San Francisco, San Jose already likely listed
    { name: "Fresno", lat: 36.7468, lng: -119.7726, population: 1000000 }, // California (Metro)
    { name: "Long Beach", lat: 33.7701, lng: -118.1937, population: 18700000 }, // California (Part of LA Metro)
    { name: "Oakland", lat: 37.8044, lng: -122.2712, population: 4700000 }, // California (Part of SF Bay Area Metro)
    { name: "Bakersfield", lat: 35.3733, lng: -119.0187, population: 900000 }, // California (Metro)
    { name: "Anaheim", lat: 33.8366, lng: -117.9143, population: 3200000 }, // California (Part of LA Metro - Orange County)
    { name: "Santa Ana", lat: 33.7455, lng: -117.8677, population: 3200000 }, // California (Part of LA Metro - Orange County)
    { name: "Riverside", lat: 33.9806, lng: -117.3755, population: 4600000 }, // California (Inland Empire Metro)
    { name: "Stockton", lat: 37.9577, lng: -121.2908, population: 780000 }, // California (Metro)
    { name: "Chula Vista", lat: 32.6401, lng: -117.0842, population: 3300000 }, // California (Part of San Diego Metro)
    { name: "Irvine", lat: 33.6846, lng: -117.8265, population: 3200000 }, // California (Part of LA Metro - Orange County)
    { name: "San Bernardino", lat: 34.1083, lng: -117.2898, population: 4600000 }, // California (Inland Empire Metro)
    { name: "Modesto", lat: 37.6391, lng: -120.9969, population: 550000 }, // California (Metro)
    { name: "Oxnard", lat: 34.1975, lng: -119.1772, population: 850000 }, // California (Metro)
    { name: "Fontana", lat: 34.0922, lng: -117.4350, population: 4600000 }, // California (Inland Empire Metro)
    { name: "Moreno Valley", lat: 33.9420, lng: -117.2297, population: 4600000 }, // California (Inland Empire Metro)
    // Colorado Springs already likely listed
    { name: "Aurora (CO)", lat: 39.7294, lng: -104.8319, population: 2900000 }, // Colorado (Part of Denver Metro)
    { name: "Fort Collins", lat: 40.5853, lng: -105.0844, population: 360000 }, // Colorado (Metro)
    { name: "Bridgeport", lat: 41.1866, lng: -73.1956, population: 950000 }, // Connecticut (Metro)
    { name: "New Haven", lat: 41.3083, lng: -72.9279, population: 860000 }, // Connecticut (Metro)
    { name: "Stamford", lat: 41.0534, lng: -73.5387, population: 950000 }, // Connecticut (Part of Bridgeport Metro / NYC influence)
    { name: "Wilmington (DE)", lat: 39.7391, lng: -75.5398, population: 710000 }, // Delaware (Metro, part of Philadelphia-Wilmington MSA)
    // Jacksonville, Miami, Tampa, Orlando, St. Petersburg already likely listed
    { name: "Hialeah", lat: 25.8576, lng: -80.2781, population: 6100000 }, // Florida (Part of Miami Metro)
    { name: "Fort Lauderdale", lat: 26.1224, lng: -80.1373, population: 6100000 }, // Florida (Part of Miami Metro)
    { name: "Port St. Lucie", lat: 27.2981, lng: -80.3503, population: 490000 }, // Florida (Metro)
    { name: "Cape Coral", lat: 26.6406, lng: -81.9495, population: 800000 }, // Florida (Metro)
    { name: "Pembroke Pines", lat: 26.0098, lng: -80.3300, population: 6100000 }, // Florida (Part of Miami Metro)
    { name: "Hollywood (FL)", lat: 26.0112, lng: -80.1495, population: 6100000 }, // Florida (Part of Miami Metro)
    { name: "Gainesville (FL)", lat: 29.6516, lng: -82.3248, population: 290000 }, // Florida (Metro)
    // Augusta, GA (different from ME capital)
    { name: "Augusta (GA)", lat: 33.4735, lng: -82.0105, population: 610000 }, // Georgia (Metro)
    { name: "Columbus (GA)", lat: 32.4610, lng: -84.9877, population: 320000 }, // Georgia (Metro)
    { name: "Macon", lat: 32.8407, lng: -83.6324, population: 230000 }, // Georgia (Metro)
    { name: "Savannah", lat: 32.0809, lng: -81.0912, population: 400000 }, // Georgia (Metro)
    // Chicago, Aurora (IL) already likely listed
    { name: "Rockford", lat: 42.2711, lng: -89.0940, population: 340000 }, // Illinois (Metro)
    { name: "Joliet", lat: 41.5250, lng: -88.0817, population: 9500000 }, // Illinois (Part of Chicago Metro)
    { name: "Naperville", lat: 41.7508, lng: -88.1528, population: 9500000 }, // Illinois (Part of Chicago Metro)
    { name: "Peoria (IL)", lat: 40.6936, lng: -89.5890, population: 370000 }, // Illinois (Metro)
    // Fort Wayne, Evansville already likely listed (if large enough for your initial criteria)
    { name: "South Bend", lat: 41.6764, lng: -86.2520, population: 320000 }, // Indiana (Metro)
    // Cedar Rapids, Davenport already likely listed
    { name: "Sioux City", lat: 42.4925, lng: -96.3923, population: 170000 }, // Iowa (Metro)
    // Kansas City (KS) & Wichita already likely listed
    { name: "Overland Park", lat: 38.9822, lng: -94.6708, population: 2000000 }, // Kansas (Part of Kansas City Metro)
    { name: "Lexington", lat: 38.0406, lng: -84.5037, population: 520000 }, // Kentucky (Metro)
    { name: "Louisville", lat: 38.2527, lng: -85.7585, population: 1300000 }, // Kentucky (Metro)
    // New Orleans, Shreveport already likely listed
    { name: "Lafayette (LA)", lat: 30.2241, lng: -92.0198, population: 490000 }, // Louisiana (Metro)
    { name: "Lake Charles", lat: 30.2266, lng: -93.2174, population: 210000 }, // Louisiana (Metro)
    // Baltimore already likely listed
    { name: "Frederick (MD)", lat: 39.4143, lng: -77.4105, population: 6300000 }, // Maryland (Part of Washington DC Metro)
    { name: "Gaithersburg", lat: 39.1434, lng: -77.2014, population: 6300000 }, // Maryland (Part of Washington DC Metro)
    // Worcester, Springfield (MA) already likely listed
    { name: "Cambridge (MA)", lat: 42.3736, lng: -71.1097, population: 4900000 }, // Massachusetts (Part of Boston Metro)
    // Detroit, Grand Rapids, Warren already likely listed
    { name: "Sterling Heights", lat: 42.5803, lng: -83.0302, population: 4300000 }, // Michigan (Part of Detroit Metro)
    { name: "Ann Arbor", lat: 42.2808, lng: -83.7430, population: 370000 }, // Michigan (Metro)
    // Minneapolis already listed (as part of St. Paul capital region)
    { name: "Rochester (MN)", lat: 44.0232, lng: -92.4669, population: 220000 }, // Minnesota (Metro)
    { name: "Duluth", lat: 46.7867, lng: -92.1005, population: 280000 }, // Minnesota (Metro)
    { name: "Gulfport", lat: 30.3674, lng: -89.0928, population: 400000 }, // Mississippi (Metro)
    // Kansas City (MO), Saint Louis already likely listed
    { name: "Springfield (MO)", lat: 37.2090, lng: -93.2923, population: 470000 }, // Missouri (Metro)
    { name: "Independence (MO)", lat: 39.0911, lng: -94.4155, population: 2000000 }, // Missouri (Part of Kansas City Metro)
    { name: "Billings", lat: 45.7833, lng: -108.5007, population: 180000 }, // Montana (Metro)
    { name: "Missoula", lat: 46.8721, lng: -113.9940, population: 120000 }, // Montana (Metro)
    // Omaha already likely listed
    // Las Vegas, Henderson, Reno already likely listed
    { name: "North Las Vegas", lat: 36.1997, lng: -115.1200, population: 2200000 }, // Nevada (Part of Las Vegas Metro)
    { name: "Manchester (NH)", lat: 42.9956, lng: -71.4548, population: 410000 }, // New Hampshire (Metro)
    // Newark, Jersey City, Paterson, Elizabeth already likely listed (if large enough for initial criteria)
    { name: "Albuquerque", lat: 35.0844, lng: -106.6504, population: 920000 }, // New Mexico (Metro)
    { name: "Las Cruces", lat: 32.3199, lng: -106.7637, population: 220000 }, // New Mexico (Metro)
    // New York City, Buffalo, Rochester (NY) already likely listed
    { name: "Yonkers", lat: 40.9312, lng: -73.8987, population: 20100000 }, // New York (Part of NYC Metro)
    { name: "Syracuse", lat: 43.0481, lng: -76.1474, population: 660000 }, // New York (Metro)
    // Charlotte, Greensboro, Durham, Winston-Salem already likely listed
    { name: "Fayetteville (NC)", lat: 35.0527, lng: -78.8786, population: 530000 }, // North Carolina (Metro)
    { name: "Cary", lat: 35.7915, lng: -78.7811, population: 1400000 }, // North Carolina (Part of Raleigh Metro)
    { name: "Wilmington (NC)", lat: 34.2257, lng: -77.9447, population: 300000 }, // North Carolina (Metro)
    { name: "Fargo", lat: 46.8772, lng: -96.7898, population: 250000 }, // North Dakota (Metro, includes Moorhead, MN)
    // Cleveland, Cincinnati, Toledo, Akron, Dayton already likely listed
    // Tulsa already likely listed
    // Portland (OR) already likely listed
    { name: "Eugene", lat: 44.0521, lng: -123.0868, population: 380000 }, // Oregon (Metro)
    { name: "Gresham", lat: 45.5051, lng: -122.4350, population: 2000000 }, // Oregon (Part of Portland Metro)
    // Philadelphia, Pittsburgh, Allentown already likely listed
    { name: "Erie", lat: 42.1292, lng: -80.0851, population: 270000 }, // Pennsylvania (Metro)
    { name: "Reading", lat: 40.3356, lng: -75.9269, population: 420000 }, // Pennsylvania (Metro)
    { name: "Scranton", lat: 41.4090, lng: -75.6624, population: 560000 }, // Pennsylvania (Metro)
    // Charleston (SC), Greenville (SC) already likely listed
    { name: "Myrtle Beach", lat: 33.6891, lng: -78.8869, population: 500000 }, // South Carolina (Metro)
    { name: "Sioux Falls", lat: 43.5460, lng: -96.7313, population: 270000 }, // South Dakota (Metro)
    // Memphis, Knoxville, Chattanooga already likely listed
    // Houston, San Antonio, Dallas, Fort Worth, El Paso already likely listed
    { name: "Arlington (TX)", lat: 32.7357, lng: -97.1081, population: 7600000 }, // Texas (Part of Dallas-Fort Worth Metroplex)
    { name: "Corpus Christi", lat: 27.8006, lng: -97.3964, population: 440000 }, // Texas (Metro)
    { name: "Plano", lat: 33.0198, lng: -96.6989, population: 7600000 }, // Texas (Part of Dallas-Fort Worth Metroplex)
    { name: "Laredo", lat: 27.5242, lng: -99.4800, population: 260000 }, // Texas (Metro)
    { name: "Lubbock", lat: 33.5779, lng: -101.8552, population: 320000 }, // Texas (Metro)
    { name: "Garland", lat: 32.9126, lng: -96.6411, population: 7600000 }, // Texas (Part of Dallas-Fort Worth Metroplex)
    { name: "Irving", lat: 32.8140, lng: -96.9489, population: 7600000 }, // Texas (Part of Dallas-Fort Worth Metroplex)
    { name: "Amarillo", lat: 35.2220, lng: -101.8313, population: 270000 }, // Texas (Metro)
    { name: "Brownsville", lat: 25.9018, lng: -97.4975, population: 420000 }, // Texas (Metro)
    { name: "McKinney", lat: 33.1979, lng: -96.6153, population: 7600000 }, // Texas (Part of Dallas-Fort Worth Metroplex)
    { name: "Frisco", lat: 33.1507, lng: -96.8236, population: 7600000 }, // Texas (Part of Dallas-Fort Worth Metroplex)
    { name: "Pasadena (TX)", lat: 29.6911, lng: -95.2091, population: 7100000 }, // Texas (Part of Houston Metro)
    { name: "Killeen", lat: 31.1171, lng: -97.7278, population: 450000 }, // Texas (Metro)
    { name: "Waco", lat: 31.5493, lng: -97.1467, population: 270000 }, // Texas (Metro)
    // West Valley City, Provo already likely listed
    // Virginia Beach, Norfolk, Chesapeake, Newport News already likely listed
    { name: "Alexandria (VA)", lat: 38.8048, lng: -77.0469, population: 6300000 }, // Virginia (Part of Washington DC Metro)
    { name: "Hampton", lat: 37.0299, lng: -76.3452, population: 1700000 }, // Virginia (Part of Hampton Roads Metro)
    { name: "Roanoke", lat: 37.2710, lng: -79.9414, population: 310000 }, // Virginia (Metro)
    // Seattle, Spokane, Tacoma, Vancouver (WA) already likely listed
    { name: "Bellevue", lat: 47.6101, lng: -122.2015, population: 4000000 }, // Washington (Part of Seattle Metro)
    { name: "Kent (WA)", lat: 47.3809, lng: -122.2348, population: 4000000 }, // Washington (Part of Seattle Metro)
    // Milwaukee already likely listed
    { name: "Green Bay", lat: 44.5192, lng: -88.0198, population: 320000 }, // Wisconsin (Metro)
// --- END OF NEW US CITIES ---
    { name: "Calgary", lat: 51.0447, lng: -114.0719, population: 1600000 }, // Canada, Metro
    { name: "Edmonton", lat: 53.5461, lng: -113.4938, population: 1400000 }, // Canada, Metro
    { name: "Ottawa", lat: 45.4215, lng: -75.6972, population: 1400000 }, // Canada, Metro (includes Gatineau)
    { name: "Quebec City", lat: 46.8139, lng: -71.2080, population: 800000 }, // Canada, Metro
    { name: "Winnipeg", lat: 49.8951, lng: -97.1384, population: 800000 }, // Canada, Metro
    { name: "Hamilton (Canada)", lat: 43.2557, lng: -79.8711, population: 800000 }, // Canada, Metro
    { name: "Tijuana", lat: 32.5149, lng: -117.0382, population: 2100000 }, // Mexico, Metro
    { name: "Guadalajara", lat: 20.6597, lng: -103.3496, population: 5200000 }, // Mexico, Metro
    { name: "Monterrey", lat: 25.6866, lng: -100.3161, population: 5300000 }, // Mexico, Metro
    { name: "Puebla", lat: 19.0414, lng: -98.2063, population: 3200000 }, // Mexico, Metro
    { name: "Leon (Mexico)", lat: 21.1250, lng: -101.6850, population: 1900000 }, // Mexico, Metro
    { name: "Ciudad Juarez", lat: 31.7300, lng: -106.4810, population: 1500000 }, // Mexico
    { name: "Guatemala City", lat: 14.6349, lng: -90.5069, population: 3000000 }, // Guatemala, Metro
    { name: "San Salvador", lat: 13.6929, lng: -89.2182, population: 1800000 }, // El Salvador, Metro
    { name: "Tegucigalpa", lat: 14.0723, lng: -87.1921, population: 1300000 }, // Honduras
    { name: "Managua", lat: 12.1150, lng: -86.2362, population: 1100000 }, // Nicaragua
    { name: "San Jose (Costa Rica)", lat: 9.9281, lng: -84.0907, population: 2100000 }, // Costa Rica, Metro
    { name: "Panama City", lat: 8.9824, lng: -79.5199, population: 1900000 }, // Panama, Metro
    { name: "Santo Domingo", lat: 18.4861, lng: -69.9312, population: 3300000 }, // Dominican Republic, Metro
    { name: "Port-au-Prince", lat: 18.5333, lng: -72.3333, population: 2600000 }, // Haiti, Metro
    { name: "Kingston (Jamaica)", lat: 17.9717, lng: -76.7930, population: 1200000 }, // Jamaica, Metro
    { name: "San Juan (Puerto Rico)", lat: 18.4655, lng: -66.1057, population: 2200000 }, // Puerto Rico, USA, Metro
    { name: "Belo Horizonte", lat: -19.9167, lng: -43.9345, population: 6000000 }, // Brazil, Metro
    { name: "Porto Alegre", lat: -30.0346, lng: -51.2177, population: 4400000 }, // Brazil, Metro
    { name: "Manaus", lat: -3.1190, lng: -60.0217, population: 2200000 }, // Brazil
    { name: "Belem", lat: -1.4558, lng: -48.5023, population: 2500000 }, // Brazil, Metro
    { name: "Goiania", lat: -16.6869, lng: -49.2649, population: 2600000 }, // Brazil, Metro
    { name: "Campinas", lat: -22.9071, lng: -47.0630, population: 3200000 }, // Brazil, Metro
    { name: "Maracaibo", lat: 10.6400, lng: -71.6400, population: 2500000 }, // Venezuela
    { name: "Valencia (Venezuela)", lat: 10.1625, lng: -68.0077, population: 2000000 }, // Venezuela
    { name: "Barquisimeto", lat: 10.0648, lng: -69.3570, population: 1300000 }, // Venezuela
    { name: "Cali", lat: 3.4516, lng: -76.5320, population: 2400000 }, // Colombia
    { name: "Barranquilla", lat: 10.9639, lng: -74.7964, population: 2000000 }, // Colombia, Metro
    { name: "Cartagena (Colombia)", lat: 10.3910, lng: -75.4794, population: 1000000 }, // Colombia
    { name: "La Paz", lat: -16.4897, lng: -68.1193, population: 1800000 }, // Bolivia, Metro (includes El Alto)
    { name: "Santa Cruz de la Sierra", lat: -17.7833, lng: -63.1821, population: 2000000 }, // Bolivia
    { name: "Asuncion", lat: -25.2637, lng: -57.5759, population: 2200000 }, // Paraguay, Metro
    { name: "Cordoba (Argentina)", lat: -31.4201, lng: -64.1888, population: 1600000 }, // Argentina, Metro
    { name: "Rosario", lat: -32.9470, lng: -60.6760, population: 1400000 }, // Argentina, Metro
    { name: "Mendoza", lat: -32.8895, lng: -68.8458, population: 1000000 }, // Argentina, Metro
    { name: "Hamburg", lat: 53.5511, lng: 9.9937, population: 5000000 }, // Germany, Metro
    { name: "Munich", lat: 48.1351, lng: 11.5820, population: 6000000 }, // Germany, Metro
    { name: "Cologne", lat: 50.9375, lng: 6.9603, population: 3600000 }, // Germany, Metro
    { name: "Frankfurt", lat: 50.1109, lng: 8.6821, population: 5600000 }, // Germany, Metro (Rhine-Main)
    { name: "Stuttgart", lat: 48.7758, lng: 9.1829, population: 5300000 }, // Germany, Metro
    { name: "Dusseldorf", lat: 51.2277, lng: 6.7735, population: 3000000 }, // Germany, Metro (Rhine-Ruhr part)
    { name: "Dortmund", lat: 51.5136, lng: 7.4653, population: 1000000 }, // Germany (Ruhr part)
    { name: "Essen", lat: 51.4556, lng: 7.0116, population: 1000000 }, // Germany (Ruhr part)
    { name: "Leipzig", lat: 51.3397, lng: 12.3731, population: 1000000 }, // Germany, Metro
    { name: "Dresden", lat: 51.0504, lng: 13.7373, population: 800000 }, // Germany, Metro
    { name: "Birmingham (UK)", lat: 52.4862, lng: -1.8904, population: 3700000 }, // UK, Metro
    { name: "Manchester", lat: 53.4808, lng: -2.2426, population: 2700000 }, // UK, Metro
    { name: "Glasgow", lat: 55.8642, lng: -4.2518, population: 1700000 }, // UK, Metro
    { name: "Liverpool", lat: 53.4084, lng: -2.9916, population: 1500000 }, // UK, Metro
    { name: "Leeds", lat: 53.8008, lng: -1.5491, population: 1800000 }, // UK, Metro
    { name: "Marseille", lat: 43.2965, lng: 5.3698, population: 1700000 }, // France, Metro
    { name: "Lyon", lat: 45.7640, lng: 4.8357, population: 2300000 }, // France, Metro
    { name: "Toulouse", lat: 43.6047, lng: 1.4442, population: 1400000 }, // France, Metro
    { name: "Nice", lat: 43.7102, lng: 7.2620, population: 1000000 }, // France, Metro
    { name: "Milan", lat: 45.4642, lng: 9.1900, population: 4300000 }, // Italy, Metro
    { name: "Naples", lat: 40.8518, lng: 14.2681, population: 3100000 }, // Italy, Metro
    { name: "Turin", lat: 45.0703, lng: 7.6869, population: 2200000 }, // Italy, Metro
    { name: "Palermo", lat: 38.1157, lng: 13.3615, population: 1000000 }, // Italy, Metro
    { name: "Genoa", lat: 44.4056, lng: 8.9463, population: 800000 }, // Italy, Metro
    { name: "Florence", lat: 43.7696, lng: 11.2558, population: 1000000 }, // Italy, Metro
    { name: "Bologna", lat: 44.4949, lng: 11.3426, population: 1000000 }, // Italy, Metro
    { name: "Barcelona", lat: 41.3851, lng: 2.1734, population: 5500000 }, // Spain, Metro
    { name: "Valencia (Spain)", lat: 39.4699, lng: -0.3763, population: 2500000 }, // Spain, Metro
    { name: "Seville", lat: 37.3891, lng: -5.9845, population: 1500000 }, // Spain, Metro
    { name: "Zaragoza", lat: 41.6488, lng: -0.8891, population: 700000 }, // Spain
    { name: "Malaga", lat: 36.7213, lng: -4.4214, population: 1000000 }, // Spain, Metro
    { name: "Rotterdam", lat: 51.9244, lng: 4.4777, population: 1400000 }, // Netherlands, Metro
    { name: "The Hague", lat: 52.0705, lng: 4.3007, population: 1100000 }, // Netherlands, Metro
    { name: "Antwerp", lat: 51.2194, lng: 4.4025, population: 1200000 }, // Belgium, Metro
    { name: "Krakow", lat: 50.0647, lng: 19.9450, population: 1700000 }, // Poland, Metro
    { name: "Lodz", lat: 51.7592, lng: 19.4560, population: 1000000 }, // Poland, Metro
    { name: "Poznan", lat: 52.4064, lng: 16.9252, population: 1000000 }, // Poland, Metro
    { name: "Gdansk", lat: 54.3520, lng: 18.6466, population: 1000000 },
    /// MEXICO 
    { name: "Aguascalientes City", lat: 21.8823, lng: -102.2826, population: 1140000, isCapital: true }, // Aguascalientes
    { name: "Mexicali", lat: 32.6278, lng: -115.4545, population: 1050000, isCapital: true }, // Baja California
    { name: "La Paz (Mexico)", lat: 24.1423, lng: -110.3124, population: 300000, isCapital: true }, // Baja California Sur
    { name: "Campeche City", lat: 19.8301, lng: -90.5349, population: 300000, isCapital: true }, // Campeche
    { name: "Tuxtla Gutierrez", lat: 16.7537, lng: -93.1156, population: 850000, isCapital: true }, // Chiapas
    { name: "Chihuahua City", lat: 28.6329, lng: -106.0691, population: 950000, isCapital: true }, // Chihuahua
    { name: "Saltillo", lat: 25.4232, lng: -101.0000, population: 1030000, isCapital: true }, // Coahuila
    { name: "Colima City", lat: 19.2450, lng: -103.7250, population: 380000, isCapital: true }, // Colima
    { name: "Durango City", lat: 24.0277, lng: -104.6533, population: 700000, isCapital: true }, // Durango
    { name: "Guanajuato City", lat: 21.0190, lng: -101.2574, population: 200000, isCapital: true }, // Guanajuato
    { name: "Chilpancingo", lat: 17.5512, lng: -99.5024, population: 300000, isCapital: true }, // Guerrero
    { name: "Pachuca", lat: 20.1214, lng: -98.7372, population: 650000, isCapital: true }, // Hidalgo
    // Guadalajara is Jalisco's capital, likely already listed. Add isCapital: true if so.
    { name: "Toluca", lat: 19.2826, lng: -99.6557, population: 2600000, isCapital: true }, // State of Mexico
    { name: "Morelia", lat: 19.7028, lng: -101.1922, population: 1000000, isCapital: true }, // Michoacn
    { name: "Cuernavaca", lat: 18.9254, lng: -99.2307, population: 1000000, isCapital: true }, // Morelos
    { name: "Tepic", lat: 21.5084, lng: -104.8933, population: 500000, isCapital: true }, // Nayarit
    // Monterrey is Nuevo Len's capital, likely already listed. Add isCapital: true.
    { name: "Oaxaca City", lat: 17.0732, lng: -96.7266, population: 700000, isCapital: true }, // Oaxaca
    // Puebla City is Puebla's capital, likely already listed. Add isCapital: true.
    { name: "Queretaro City", lat: 20.5888, lng: -100.3899, population: 1600000, isCapital: true }, // Quertaro
    { name: "Chetumal", lat: 18.5036, lng: -88.3046, population: 200000, isCapital: true }, // Quintana Roo
    { name: "San Luis Potosi City", lat: 22.1565, lng: -100.9795, population: 1200000, isCapital: true }, // San Luis Potos
    { name: "Culiacan", lat: 24.7903, lng: -107.3878, population: 1000000, isCapital: true }, // Sinaloa
    { name: "Hermosillo", lat: 29.0729, lng: -110.9670, population: 950000, isCapital: true }, // Sonora
    { name: "Villahermosa", lat: 17.9869, lng: -92.9303, population: 850000, isCapital: true }, // Tabasco
    { name: "Ciudad Victoria", lat: 23.7360, lng: -99.1409, population: 350000, isCapital: true }, // Tamaulipas
    { name: "Tlaxcala City", lat: 19.3177, lng: -98.2394, population: 100000, isCapital: true }, // Tlaxcala
    { name: "Xalapa", lat: 19.5437, lng: -96.9100, population: 700000, isCapital: true }, // Veracruz
    { name: "Merida (Mexico)", lat: 20.9674, lng: -89.5926, population: 1300000, isCapital: true }, // Yucatn
    { name: "Zacatecas City", lat: 22.7709, lng: -102.5734, population: 350000, isCapital: true }, // Zacatecas

// Other Major/Significant Mexican Cities & Towns (some might overlap with capitals if they are also major cities)
    // Baja California
    // Tijuana is likely already in your list.
    { name: "Ensenada", lat: 31.8660, lng: -116.5965, population: 550000 },
    // Sonora
    { name: "Ciudad Obregon", lat: 27.4942, lng: -109.9400, population: 430000 },
    { name: "Nogales (Sonora)", lat: 31.3086, lng: -110.9425, population: 260000 },
    // Chihuahua
    // Ciudad Juarez is likely already listed.
    { name: "Delicias", lat: 28.1914, lng: -105.4703, population: 150000 },
    // Coahuila
    { name: "Torreon", lat: 25.5428, lng: -103.4068, population: 1500000 }, // Major Metro (La Laguna)
    { name: "Monclova", lat: 26.9089, lng: -101.4211, population: 380000 },
    // Nuevo Len
    // Monterrey's suburbs form a large metro, like:
    { name: "Guadalupe (Nuevo Leon)", lat: 25.6750, lng: -100.2580, population: 700000 }, // Part of Monterrey Metro
    { name: "Apodaca", lat: 25.7799, lng: -100.1888, population: 650000 }, // Part of Monterrey Metro
    { name: "San Nicolas de los Garza", lat: 25.7500, lng: -100.2833, population: 450000 }, // Part of Monterrey Metro
    // Tamaulipas
    { name: "Reynosa", lat: 26.0767, lng: -98.2977, population: 700000 },
    { name: "Matamoros", lat: 25.8655, lng: -97.5038, population: 550000 },
    { name: "Nuevo Laredo", lat: 27.4819, lng: -99.5153, population: 450000 },
    { name: "Tampico", lat: 22.2530, lng: -97.8686, population: 930000 }, // Metro
    // San Luis Potos
    { name: "Soledad de Graciano Sanchez", lat: 22.1869, lng: -100.9408, population: 350000 }, // Part of SLP Metro
    // Guanajuato
    // Leon is likely already listed.
    { name: "Irapuato", lat: 20.6722, lng: -101.3478, population: 850000 },
    { name: "Celaya", lat: 20.5270, lng: -100.8115, population: 500000 },
    { name: "Salamanca (Mexico)", lat: 20.5714, lng: -101.1981, population: 270000 },
    // Jalisco
    // Guadalajara's suburbs form a large metro, like:
    { name: "Zapopan", lat: 20.7200, lng: -103.3911, population: 1500000 }, // Part of Guadalajara Metro
    { name: "Tlaquepaque", lat: 20.6390, lng: -103.3100, population: 700000 }, // Part of Guadalajara Metro
    { name: "Tonala", lat: 20.6233, lng: -103.2370, population: 570000 }, // Part of Guadalajara Metro
    { name: "Puerto Vallarta", lat: 20.6534, lng: -105.2253, population: 500000 }, // Metro
    // Michoacn
    { name: "Uruapan", lat: 19.4206, lng: -102.0628, population: 360000 },
    // State of Mexico (Many are part of Greater Mexico City)
    { name: "Ecatepec de Morelos", lat: 19.6000, lng: -99.0600, population: 1700000 }, // Part of Greater Mexico City
    { name: "Nezahualcoyotl", lat: 19.4000, lng: -99.0167, population: 1100000 }, // Part of Greater Mexico City
    { name: "Naucalpan de Juarez", lat: 19.4733, lng: -99.2369, population: 850000 }, // Part of Greater Mexico City
    { name: "Tlalnepantla de Baz", lat: 19.5369, lng: -99.1956, population: 700000 }, // Part of Greater Mexico City
    // Puebla
    { name: "Tehuacan", lat: 18.4625, lng: -97.3925, population: 330000 },
    // Veracruz
    { name: "Veracruz City", lat: 19.1738, lng: -96.1342, population: 1000000 }, // Metro
    { name: "Coatzacoalcos", lat: 18.1426, lng: -94.4408, population: 320000 },
    { name: "Poza Rica", lat: 20.5333, lng: -97.4500, population: 520000 }, // Metro
    // Guerrero
    { name: "Acapulco", lat: 16.8494, lng: -99.9087, population: 850000 },
    // Oaxaca
    // Salina Cruz, Juchitn
    // Chiapas
    { name: "Tapachula", lat: 14.9068, lng: -92.2619, population: 350000 },
    { name: "San Cristobal de las Casas", lat: 16.7370, lng: -92.6377, population: 220000 },
    // Tabasco
    // Crdenas
    // Campeche
    { name: "Ciudad del Carmen", lat: 18.6416, lng: -91.8330, population: 250000 },
    // Yucatn
    // Progreso
    // Quintana Roo
    { name: "Cancun", lat: 21.1619, lng: -86.8515, population: 1000000 },
    { name: "Playa del Carmen", lat: 20.6274, lng: -87.0811, population: 300000 }
// --- END OF NEW MEXICAN CITIES/TOWNS --- // Poland, Tri-City Metro
];

        // Global State
        let bombHistory = [];
        let cumulativeWorldwideFatalities = 0;
        let cumulativeWorldwideInjured = 0;
        let bombDropCounter = 0;
        let initialTotalWorldPopulation = 0;
        let globalUnlistedInitialPopulation = 1500000000; // Estimate for population not in majorCities, adjust as needed
        let globalUnlistedRemainingPopulation = 0;


        function initializePopulations() {
            let sumOfListedPopulation = 0;
            majorCities.forEach(city => {
                city.remainingPopulation = city.population; // Add remainingPopulation property
                sumOfListedPopulation += city.population;
                if (city.isCapital === undefined) city.isCapital = false; // Ensure isCapital exists
            });
            globalUnlistedRemainingPopulation = globalUnlistedInitialPopulation;
            initialTotalWorldPopulation = sumOfListedPopulation + globalUnlistedRemainingPopulation;

            initialWorldPopDisplay.textContent = initialTotalWorldPopulation.toLocaleString();
            updateWorldwideTotalsUI(); // Initialize UI for remaining population
        }


        function getDistanceKm(latlng1, latlng2_obj) { /* ... same as before ... */ return 6371 * 2 * Math.atan2(Math.sqrt(Math.sin(deg2rad(latlng2_obj.lat - latlng1.lat)/2)**2 + Math.cos(deg2rad(latlng1.lat)) * Math.cos(deg2rad(latlng2_obj.lat)) * Math.sin(deg2rad(latlng2_obj.lng - latlng1.lng)/2)**2), Math.sqrt(1-(Math.sin(deg2rad(latlng2_obj.lat - latlng1.lat)/2)**2 + Math.cos(deg2rad(latlng1.lat)) * Math.cos(deg2rad(latlng2_obj.lat)) * Math.sin(deg2rad(latlng2_obj.lng - latlng1.lng)/2)**2)));}
        function deg2rad(deg) { return deg * (Math.PI / 180); }
        function formatKT(value) { return value >= 1000 ? (value / 1000).toFixed(1) + " MT" : value + " KT"; }

        bombPowerInput.addEventListener('input', (event) => { bombPowerValueDisplay.textContent = formatKT(parseInt(event.target.value)); });
        bombPowerValueDisplay.textContent = formatKT(parseInt(bombPowerInput.value));

        map.on('click', function(e) {
            bombDropCounter++;
            const latlng = e.latlng;
            const bombPowerKT = parseInt(bombPowerInput.value);
            const impactData = calculateAndApplyImpact(latlng, bombPowerKT); // This function now applies changes

            createExplosion(latlng, bombPowerKT, parseInt(numWavesInput.value), parseInt(waveDurationInput.value));
            updateCurrentImpactUI(latlng, bombPowerKT, impactData);

            const bombEvent = {
                id: bombDropCounter, lat: latlng.lat, lng: latlng.lng, powerKT: bombPowerKT,
                fatalities: impactData.fatalitiesThisBomb, injured: impactData.injuredThisBomb,
                timestamp: new Date(), nearestCityInfo: impactData.primaryAffectedCity || "Open Area"
            };
            bombHistory.push(bombEvent);

            cumulativeWorldwideFatalities += impactData.fatalitiesThisBomb;
            cumulativeWorldwideInjured += impactData.injuredThisBomb;

            renderBombHistory();
            updateWorldwideTotalsUI();

            if (parseFloat(totalRemainingPopWorldDisplay.textContent.replace(/,/g, '')) === 0) {
                alert("Congratulations... You have achieved total human extinction.");
            }
        });

        function createExplosion(latlng, powerKT, numWavesConfig, durationMs) { /* ... same as before ... */ const yieldFactor=Math.pow(powerKT,1/3);const baseMaxRadiusMeters=yieldFactor*20000;const waveDelay=durationMs/(numWavesConfig>1?numWavesConfig*1.5:1);const shockwaveColors=['#FF4500','#FF8C00','#FFA500'];const fireballColorStart='#FFFFE0',fireballColorPeak='#FFA500';const fireballDuration=durationMs*0.4;const fireballMaxRadius=baseMaxRadiusMeters*0.15*Math.max(1,Math.pow(powerKT/10,0.05));const fireball=L.circle(latlng,{radius:1,color:fireballColorPeak,fillColor:fireballColorStart,fillOpacity:0.95,weight:1,interactive:false}).addTo(map);let fireballStartTime=null;function animateFireball(timestamp){if(!map.hasLayer(fireball))return;if(!fireballStartTime)fireballStartTime=timestamp;const elapsed=timestamp-fireballStartTime;const progressRatio=Math.min(elapsed/fireballDuration,1);fireball.setRadius(easeInOutCubic(progressRatio)*fireballMaxRadius);if(progressRatio<0.5)fireball.setStyle({fillColor:interpolateColor(fireballColorStart,fireballColorPeak,progressRatio*2),fillOpacity:0.95});else fireball.setStyle({fillColor:fireballColorPeak,fillOpacity:0.95*(1-(progressRatio-0.5)*2)});if(progressRatio<1)requestAnimationFrame(animateFireball);else if(map.hasLayer(fireball))map.removeLayer(fireball)}requestAnimationFrame(animateFireball);for(let i=0;i<numWavesConfig;i++){setTimeout(()=>{let currentWaveMaxRadius=(numWavesConfig===1)?baseMaxRadiusMeters:baseMaxRadiusMeters*(0.3+i*((1.0-0.3)/(numWavesConfig-1)));const waveColor=shockwaveColors[i%shockwaveColors.length];const initialFillOpacity=0.65-(i*0.1);const wave=L.circle(latlng,{radius:1,color:waveColor,fillColor:waveColor,fillOpacity:initialFillOpacity,weight:2,interactive:false}).addTo(map);let waveStartTime=null;function animateWave(timestamp){if(!map.hasLayer(wave))return;if(!waveStartTime)waveStartTime=timestamp;const elapsed=timestamp-waveStartTime;const progressRatio=Math.min(elapsed/durationMs,1);wave.setRadius(easeOutQuad(progressRatio)*currentWaveMaxRadius);wave.setStyle({fillOpacity:initialFillOpacity*(1-Math.pow(progressRatio,1.5))});if(progressRatio<1)requestAnimationFrame(animateWave);else if(map.hasLayer(wave))map.removeLayer(wave)}requestAnimationFrame(animateWave)},(i*waveDelay)+(fireballDuration*0.25))}}

        function calculateAndApplyImpact(detonationLatLng, powerKT) {
            const severeDamageRadiusKm = Math.pow(powerKT, 1/3) * 0.8;
            const moderateDamageRadiusKm = severeDamageRadiusKm * 2.5;
            const lightDamageRadiusKm = severeDamageRadiusKm * 5;

            let totalFatalitiesThisBomb = 0;
            let totalInjuredThisBomb = 0;
            let affectedCitiesDetails = [];
            let primaryAffectedCityName = null;
            let minDistanceToPrimaryCity = Infinity;

            majorCities.forEach(city => {
                if (city.remainingPopulation === 0) return; // Skip if already empty

                const cityLatLng = { lat: city.lat, lng: city.lng };
                const distanceToCityKm = getDistanceKm(detonationLatLng, cityLatLng);

                let fatalitiesInCity = 0;
                let impactLevel = "";

                let severeGradientExponent = city.isCapital ? 1.5 : 2.0;
                let moderateGradientExponent = city.isCapital ? 1.2 : 1.5;

                const maxSevereRate = 0.65 + Math.random() * 0.3; // 65-95%
                const maxModerateRate = 0.20 + Math.random() * 0.25; // 20-45%
                const maxLightRate = 0.03 + Math.random() * 0.1; // 3-13%

                if (distanceToCityKm < severeDamageRadiusKm) {
                    const proximityFactor = Math.pow(1 - (distanceToCityKm / severeDamageRadiusKm), severeGradientExponent);
                    fatalitiesInCity = city.remainingPopulation * maxSevereRate * proximityFactor;
                    impactLevel = "Severe";
                } else if (distanceToCityKm < moderateDamageRadiusKm) {
                    const proximityFactor = Math.pow(1 - ((distanceToCityKm - severeDamageRadiusKm) / (moderateDamageRadiusKm - severeDamageRadiusKm)), moderateGradientExponent);
                    fatalitiesInCity = city.remainingPopulation * maxModerateRate * proximityFactor;
                    impactLevel = "Moderate";
                } else if (powerKT > 500 && distanceToCityKm < lightDamageRadiusKm) {
                    const proximityFactor = Math.pow(1 - ((distanceToCityKm - moderateDamageRadiusKm) / (lightDamageRadiusKm - moderateDamageRadiusKm)), 1);
                    fatalitiesInCity = city.remainingPopulation * maxLightRate * proximityFactor;
                    impactLevel = "Light";
                }

                fatalitiesInCity = Math.floor(Math.min(fatalitiesInCity, city.remainingPopulation)); // Cap at remaining
                city.remainingPopulation -= fatalitiesInCity;
                totalFatalitiesThisBomb += fatalitiesInCity;

                let injuredInCity = 0;
                if (fatalitiesInCity > 0 || impactLevel) { // Only calculate injured if there was some effect
                    // Injured are from those who were in the affected zone but survived lethal effects
                    // Estimate people in zone for injury calc: use fatality rate as proxy for "affectedness"
                    let potentialForInjuryPool = (city.population * (impactLevel ? (impactLevel === "Severe" ? maxSevereRate : maxModerateRate) : 0)) - fatalitiesInCity;
                    potentialForInjuryPool = Math.max(0, potentialForInjuryPool); // Ensure non-negative
                    
                    injuredInCity = Math.floor(Math.min(
                        fatalitiesInCity * (1.2 + Math.random() * 1.8), // Injured 1.2x to 3x fatalities
                        potentialForInjuryPool, // Cannot injure more than were in the zone and survived
                        city.remainingPopulation // And cannot injure more than currently remain alive
                    ));
                    totalInjuredThisBomb += injuredInCity;
                }


                if (fatalitiesInCity > 0 || injuredInCity > 0) {
                     affectedCitiesDetails.push(`${city.name} (${impactLevel}, F:${fatalitiesInCity.toLocaleString()}, I:${injuredInCity.toLocaleString()}, Rem:${city.remainingPopulation.toLocaleString()})`);
                    if (distanceToCityKm < minDistanceToPrimaryCity) {
                        minDistanceToPrimaryCity = distanceToCityKm;
                        primaryAffectedCityName = city.name;
                    }
                }
            });

            // Background (unlisted) population
            if (globalUnlistedRemainingPopulation > 0) {
                const backgroundFatalityRate = Math.pow(powerKT, 0.60) * (0.00000005 + Math.random() * 0.0000001); // Scaled rate
                let backgroundFatalities = Math.floor(globalUnlistedRemainingPopulation * backgroundFatalityRate);
                backgroundFatalities = Math.min(backgroundFatalities, globalUnlistedRemainingPopulation);
                globalUnlistedRemainingPopulation -= backgroundFatalities;
                totalFatalitiesThisBomb += backgroundFatalities;

                let backgroundInjured = Math.floor(Math.min(
                    backgroundFatalities * (1.0 + Math.random() * 1.0),
                    globalUnlistedRemainingPopulation
                ));
                totalInjuredThisBomb += backgroundInjured;
                if (backgroundFatalities > 0) affectedCitiesDetails.push(`Unlisted Areas (F:${backgroundFatalities.toLocaleString()}, I:${backgroundInjured.toLocaleString()})`);
            }
            
            return {
                fatalitiesThisBomb: Math.floor(totalFatalitiesThisBomb),
                injuredThisBomb: Math.floor(totalInjuredThisBomb),
                affectedCitiesList: affectedCitiesDetails,
                primaryAffectedCity: primaryAffectedCityName,
                severeDamageRadiusKm: severeDamageRadiusKm
            };
        }

        function updateCurrentImpactUI(detonationLatLng, powerKT, impactData) {
            targetCoordsDisplay.textContent = `${detonationLatLng.lat.toFixed(4)}, ${detonationLatLng.lng.toFixed(4)}`;
            estDeathsCurrentDisplay.textContent = impactData.fatalitiesThisBomb.toLocaleString();
            estInjuredCurrentDisplay.textContent = impactData.injuredThisBomb.toLocaleString();
            estDestructionDisplay.textContent = `${impactData.severeDamageRadiusKm.toFixed(2)} km`;

            let additional = "Effects vary. ";
            if (powerKT > 100) additional += "Fallout expected. ";
            if (impactData.affectedCitiesList.length > 0) {
                additional += `Impacted: ${impactData.affectedCitiesList.slice(0,3).join('; ')}` + (impactData.affectedCitiesList.length > 3 ? '...' : '.');
            } else {
                additional += "Primarily open areas.";
            }
            addInfoDisplay.textContent = additional;
        }

        function renderBombHistory() {
            bombCountDisplay.textContent = bombDropCounter;
            if (bombHistory.length === 0) { bombHistoryList.innerHTML = '<li>No bombs dropped yet.</li>'; return; }
            bombHistoryList.innerHTML = '';
            const reversedHistory = [...bombHistory].reverse();
            reversedHistory.forEach(bomb => {
                const li = document.createElement('li');
                const time = bomb.timestamp.toLocaleTimeString();
                let locInfo = bomb.nearestCityInfo || `(${bomb.lat.toFixed(1)},${bomb.lng.toFixed(1)})`;
                li.textContent = `#${bomb.id} (${formatKT(bomb.powerKT)}) @ ${locInfo} ${time}. F:${bomb.fatalities.toLocaleString()}, I:${bomb.injured.toLocaleString()}`;
                bombHistoryList.appendChild(li);
            });
        }

        function updateWorldwideTotalsUI() {
            let currentTotalRemainingInCities = 0;
            majorCities.forEach(city => { currentTotalRemainingInCities += city.remainingPopulation; });
            const worldRemaining = currentTotalRemainingInCities + globalUnlistedRemainingPopulation;

            totalFatalitiesWorldDisplay.textContent = cumulativeWorldwideFatalities.toLocaleString();
            totalInjuredWorldDisplay.textContent = cumulativeWorldwideInjured.toLocaleString();
            totalRemainingPopWorldDisplay.textContent = worldRemaining.toLocaleString();
        }

        function easeInOutCubic(t) { /* ... same ... */ return t<0.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2; }
        function easeOutQuad(t) { /* ... same ... */ return t*(2-t); }
        function interpolateColor(c1,c2,f){let r1=parseInt(c1.substring(1,3),16),g1=parseInt(c1.substring(3,5),16),b1=parseInt(c1.substring(5,7),16),r2=parseInt(c2.substring(1,3),16),g2=parseInt(c2.substring(3,5),16),b2=parseInt(c2.substring(5,7),16);let r=Math.round(r1+f*(r2-r1)),g=Math.round(g1+f*(g2-g1)),b=Math.round(b1+f*(b2-b1));return "#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).toUpperCase()}
        
        // Initialize everything
        initializePopulations();
        renderBombHistory();
    </script>
</body>
</html>